{
  "id": "snapshot_1762427708728_xinikh198",
  "approvalId": "approval_1762427708720_0ougbtaml",
  "approvalTitle": "Design for remote-server-mcp",
  "version": 1,
  "timestamp": "2025-11-06T11:15:08.728Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\nThe remote-server-mcp project will expose a Model Context Protocol (MCP) server that allows an AI agent to execute shell commands on pre-configured remote hosts. The design emphasizes simple setup, per-command isolation, and clean telemetry so that future guardrails can be layered in without refactoring core command execution.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\nNo steering documents exist yet; we adopt de-facto standards suitable for MCP tooling: TypeScript-based implementation, explicit typing, dependency injection for transports, and structured logging.\n\n### Project Structure (structure.md)\nWe follow a conventional src/ layout with domain-specific subfolders (`config`, `transport`, `services`, `hooks`, `logging`). Configuration files live under `~/.config/remote-server-mcp/` by default, while the repository holds code, tests, and documentation.\n\n## Code Reuse Analysis\nThis is a greenfield codebase. We will rely on proven OSS packages rather than in-repo reuse.\n\n### Existing Components to Leverage\n- **ssh2 (npm)**: Provides SSH client functionality, including exec channels and connection pooling.\n- **zod (npm)**: Schema validation for configuration files.\n- **winston/pino**: Structured logging sinks.\n- **yaml/toml parser**: Parse configuration into typed objects.\n\n### Integration Points\n- **Local filesystem**: Load configuration and known hosts.\n- **OS key management**: Reuse existing SSH keys or agent sockets.\n\n## Architecture\n\nWe split the system into four primary layers:\n\n1. **Configuration Layer**: Loads, validates, and hot-reloads server definitions from `config.toml` (alias, host, port, auth, defaults).\n2. **Transport Layer**: Provides an abstract `RemoteTransport` interface with an SSH implementation (`SshTransport`) that manages connection reuse and per-command channels.\n3. **Command Service**: Implements the MCP tool `runCommand`, orchestrating config lookup, transport requests, timeout handling, streaming responses, and telemetry emission.\n4. **Observability & Hooks**: `TelemetryLogger` writes structured audit events; `ExecutionHooks` exposes pre/post no-op hooks to be extended later.\n\n```mermaid\ngraph TD\n    ConfigLoader --> CommandService\n    CommandService -->|uses| TransportManager\n    TransportManager -->|channel| SshTransport\n    CommandService --> Hooks\n    CommandService --> TelemetryLogger\n    MCPServer --> CommandService\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: each module handles one concern (e.g., `config/loader.ts`, `transport/ssh.ts`).\n- **Component Isolation**: command execution does not parse config or manage sockets directly; transport-specific logic stays behind interfaces.\n- **Service Layer Separation**: MCP server routes requests into `CommandService`; output formatting happens centrally.\n- **Utility Modularity**: helpers like timeout controllers, retry policies, and output stream transformers live in `src/utils`.\n\n## Components and Interfaces\n\n### ConfigLoader\n- **Purpose:** Load and validate remote host configuration from disk (TOML/YAML).\n- **Interfaces:** `load(): Promise<Config>`; `watch(onReload)`; `getHost(alias)`.\n- **Dependencies:** file system, zod schema parser.\n- **Reuses:** zod for validation, chokidar for file watching.\n\n### TransportManager / RemoteTransport\n- **Purpose:** Abstract transport creation/reuse and provide per-command channels.\n- **Interfaces:** `execute(hostConfig, command, options): Promise<ExecutionResult>`; `stream(hostConfig, command, options, onChunk)`.\n- **Dependencies:** ssh2 client, node streams.\n- **Reuses:** `ssh2` for SSH implementation.\n\n### CommandService\n- **Purpose:** Implement MCP `runCommand` tool logic (validate request, route to transport, handle timeouts, emit telemetry).\n- **Interfaces:** `handleRunCommand(request): AsyncGenerator<RunCommandResponse>` (supports streaming) + helper methods.\n- **Dependencies:** ConfigLoader, TransportManager, ExecutionHooks, TelemetryLogger.\n\n### ExecutionHooks\n- **Purpose:** Provide pre- and post-execution extension points (no-op defaults).\n- **Interfaces:** `beforeExecute(ctx)`, `afterExecute(ctx, result)` returning promises.\n- **Dependencies:** none initially.\n\n### TelemetryLogger\n- **Purpose:** Emit structured audit logs to file/stdout and expose counters for future metrics.\n- **Interfaces:** `logCommandStart(ctx)`, `logCommandEnd(ctx, result)`, `logError(ctx, error)`.\n- **Dependencies:** winston/pino, file system.\n\n### MCP Server Bootstrap\n- **Purpose:** Wire components, register tools with the MCP runtime, handle graceful shutdown and hot-reload triggers.\n- **Interfaces:** `bootstrap()` entry, signal handlers.\n- **Dependencies:** `@modelcontextprotocol/sdk` (or preferred MCP server framework).\n\n## Data Models\n\n### Config Schema (TypeScript)\n```ts\nexport interface HostConfig {\n  alias: string;\n  host: string;\n  port?: number;\n  username: string;\n  auth: {\n    type: 'ssh-key' | 'ssh-agent' | 'credential-command';\n    privateKeyPath?: string;\n    passphrasePrompt?: boolean;\n    credentialCommand?: string;\n  };\n  defaultShell?: string;\n  workingDirectory?: string;\n  knownHostsPath?: string;\n  strictHostKeyChecking?: boolean;\n  connection?: {\n    keepAliveIntervalMs?: number;\n    maxPoolSize?: number;\n  };\n}\n```\n\n### RunCommand Request/Result\n```ts\nexport interface RunCommandRequest {\n  hostAlias: string;\n  command: string;\n  timeoutMs?: number;\n  stream?: boolean;\n}\n\nexport interface CommandChunk {\n  type: 'stdout' | 'stderr';\n  data: string;\n  timestamp: string;\n}\n\nexport interface RunCommandResult {\n  exitCode: number | null;\n  stdout: string;\n  stderr: string;\n  timedOut: boolean;\n  durationMs: number;\n}\n```\n\n### Telemetry Event\n```ts\nexport interface CommandAuditEvent {\n  id: string;\n  timestamp: string;\n  hostAlias: string;\n  commandSummary: string;\n  timeoutMs: number;\n  status: 'started' | 'succeeded' | 'failed' | 'timed-out';\n  exitCode?: number;\n  durationMs?: number;\n  errorMessage?: string;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **Invalid configuration entry**\n   - **Handling:** validation error thrown during load; bootstrap refuses to start; log with remediation hint.\n   - **User Impact:** MCP initialization fails with descriptive message referencing alias and missing fields.\n\n2. **SSH authentication failure**\n   - **Handling:** attempt configured retries with exponential backoff; if still failing, raise structured MCP error (`auth_failed`) including root cause.\n   - **User Impact:** AI receives error payload detailing host alias and reason; no command executed.\n\n3. **Command timeout**\n   - **Handling:** cancel remote channel, send timeout telemetry, flag `timedOut: true` in result.\n   - **User Impact:** AI sees command timed out and partial output if available.\n\n4. **Transport disconnection mid-stream**\n   - **Handling:** attempt reconnect + rerun if idempotent? For now, abort run, log `transport_disconnected`, bubble failure.\n   - **User Impact:** AI notified of disconnect; future iterations may add retry policies.\n\n## Testing Strategy\n\n### Unit Testing\n- Test `ConfigLoader` validation and hot-reload behavior using fixture files.\n- Mock `RemoteTransport` to verify `CommandService` handles timeouts, streaming, and hook invocation.\n- Validate hook no-ops and telemetry logging format.\n\n### Integration Testing\n- Spin up an ephemeral SSH server (e.g., `gliderlabs/ssh` or `docker sshd`) in CI to run end-to-end command execution tests, including success, auth failure, and timeout scenarios.\n- Ensure audit logs are emitted and rotation works.\n\n### End-to-End Testing\n- Use MCP client harness to call the exposed `runCommand` tool against a known host, verifying streaming responses and structured results.\n- Manual smoke test with real SSH target prior to release.\n",
  "fileStats": {
    "size": 7826,
    "lines": 184,
    "lastModified": "2025-11-06T11:14:59.032Z"
  },
  "comments": []
}